# 🚀 Cloudflare 后端部署详细步骤

本文档提供**一步一步**的详细部署指南，帮助你从零开始部署后端 API。

---

## 📋 第一步：准备工作

### 1.1 确保已安装的工具

- ✅ Node.js（推荐 v18 或更高版本）
- ✅ npm 或 yarn
- ✅ Git
- ✅ Cloudflare 账号（免费即可）

#### 📋 如何检查工具是否已安装

**1. 检查 Node.js**

打开终端（Windows: PowerShell 或 CMD，Mac/Linux: Terminal），运行：

```bash
node --version
```

**期望输出示例：**
```
v18.17.0
```
或
```
v20.10.0
```

✅ **如果显示版本号（v18 或更高）**：说明已安装，可以继续  
❌ **如果显示 "command not found" 或 "不是内部或外部命令"**：需要安装 Node.js

**安装 Node.js（如果未安装）：**
- 访问：https://nodejs.org/
- 下载并安装 LTS 版本（推荐）
- 安装完成后，重新打开终端，再次运行 `node --version` 验证

---

**2. 检查 npm（Node.js 通常自带 npm）**

在终端运行：

```bash
npm --version
```

**期望输出示例：**
```
10.2.0
```

✅ **如果显示版本号**：说明已安装  
❌ **如果没有版本号**：通常安装 Node.js 时会自动安装 npm，如果没有，重新安装 Node.js

**或者检查 yarn（如果使用 yarn）：**

```bash
yarn --version
```

---

**3. 检查 Git**

在终端运行：

```bash
git --version
```

**期望输出示例：**
```
git version 2.42.0
```

✅ **如果显示版本号**：说明已安装  
❌ **如果没有版本号**：需要安装 Git

**安装 Git（如果未安装）：**
- Windows: https://git-scm.com/download/win
- Mac: `brew install git` 或从 https://git-scm.com/download/mac 下载
- Linux: `sudo apt-get install git` 或使用对应发行版的包管理器

---

**4. 检查 Cloudflare 账号**

这不需要安装，只需要：
- ✅ 有一个 Cloudflare 账号
- ✅ 能够登录 Cloudflare Dashboard

**创建/登录 Cloudflare 账号：**
1. 访问：https://dash.cloudflare.com/
2. 如果没有账号，点击 **Sign up** 注册（免费）
3. 如果已有账号，直接登录
4. 登录成功后，能看到 Dashboard 界面，说明账号正常

**验证账号状态：**
- 登录后能正常访问 Dashboard
- 能看到左侧菜单（例如：Overview、Workers & Pages 等）

---

**5. 快速检查脚本**

你也可以一次性运行以下命令来检查所有工具：

```bash
# Windows PowerShell
Write-Host "检查 Node.js..."; node --version
Write-Host "检查 npm..."; npm --version
Write-Host "检查 Git..."; git --version
Write-Host "所有工具检查完成！"

# Mac/Linux 或 Git Bash
echo "检查 Node.js..."
node --version
echo "检查 npm..."
npm --version
echo "检查 Git..."
git --version
echo "所有工具检查完成！"
```

**如果所有工具都显示版本号**，说明环境已准备好，可以继续下一步！

### 1.2 检查项目状态

在项目根目录运行：

```bash
# 检查依赖是否已安装
npm list --depth=0

# 如果没有安装，运行
npm install
```

### 1.3 构建项目

```bash
npm run build
```

这会在 `dist/` 目录生成构建后的文件。

---

## 📦 第二步：创建 Cloudflare KV 命名空间

KV（Key-Value）存储用于保存所有数据（用户、链接、题库等）。

### 方法 A：通过 Cloudflare Dashboard（推荐）

#### 步骤 1：登录 Cloudflare
1. 打开浏览器，访问：https://dash.cloudflare.com/
2. 使用你的 Cloudflare 账号登录

#### 步骤 2：进入 KV 管理页面
1. 登录后，点击左侧菜单的 **"Workers & Pages"**
2. 在顶部菜单栏点击 **"KV"** 标签页

#### 步骤 3：创建命名空间
1. 点击右上角的 **"Create a namespace"** 按钮
2. 输入命名空间名称，例如：`psychological-assessment-db`
3. 点击 **"Add"** 创建

#### 步骤 4：创建预览环境命名空间（用于预览部署）
1. 再次点击 **"Create a namespace"**
2. 名称输入：`psychological-assessment-db-preview`
3. 点击 **"Add"** 创建

#### 步骤 5：记录命名空间 ID
1. 创建后，在 KV 命名空间列表中会显示你的命名空间
2. **重要**：点击每个命名空间，记录下它们的 **ID**（一串类似 `abc123def456...` 的字符串）
   - 生产环境命名空间 ID：例如 `abc123def456ghi789`
   - 预览环境命名空间 ID：例如 `xyz789uvw456rst123`

### 方法 B：通过 Wrangler CLI

如果你已经安装了 Wrangler CLI：

```bash
# 登录 Cloudflare
wrangler login

# 创建生产环境命名空间
wrangler kv:namespace create "DB"

# 创建预览环境命名空间
wrangler kv:namespace create "DB" --preview
```

创建后会显示命名空间 ID，请记录下来。

---

## 🌐 第三步：创建或连接 Cloudflare Pages 项目

### 情况 A：已有 Pages 项目

如果你的项目已经在 Cloudflare Pages 上：

1. 登录 Cloudflare Dashboard
2. 进入 **Workers & Pages** > **Pages**
3. 找到你的项目并点击进入

### 情况 B：创建新的 Pages 项目

#### 方式 1：通过 Git 集成（推荐）

1. **准备 Git 仓库**
   - 确保代码已推送到 GitHub/GitLab/Bitbucket

2. **在 Cloudflare 创建项目**
   - 登录 Cloudflare Dashboard
   - 进入 **Workers & Pages** > **Pages**
   - 点击 **"Create a project"**
   - 选择 **"Connect to Git"**
   - 授权 Cloudflare 访问你的 Git 仓库
   - 选择你的仓库

3. **配置构建设置**
   - **Project name**: 输入项目名称，例如：`psychological-assessment-platform`
   - **Production branch**: 通常是 `main` 或 `master`
   - **Build command**: `npm run build`
   - **Build output directory**: `dist`
   - **Root directory**: `/`（根目录）

4. **暂时跳过部署**（我们先配置 KV 绑定）

#### 方式 2：手动部署

使用 Wrangler CLI 直接部署：

```bash
# 安装 Wrangler（如果还没安装）
npm install -g wrangler

# 登录
wrangler login

# 部署
wrangler pages deploy dist --project-name=psychological-assessment-platform
```

---

## 🔗 第四步：绑定 KV 命名空间到 Pages 项目

这是**最关键的一步**，需要将 KV 命名空间连接到你的 Pages 项目。

### 步骤详解

1. **进入项目设置**
   - 在 Cloudflare Dashboard 中，进入你的 Pages 项目
   - 点击顶部菜单的 **"Settings"** 标签

2. **打开 Functions 配置**
   - 在左侧菜单中找到 **"Functions"** 并点击
   - 滚动到 **"KV namespace bindings"** 部分

3. **添加 KV 绑定 - 生产环境**
   - 点击 **"Add binding"** 按钮
   - **Variable name**: 输入 `DB`（必须完全一致，区分大小写）
   - **KV namespace**: 从下拉菜单中选择你的生产环境命名空间（例如 `psychological-assessment-db`）
   - 点击 **"Save"**

4. **添加 KV 绑定 - 预览环境**
   - 在 **"Preview"** 标签下（如果没有，先保存上面的配置）
   - 再次点击 **"Add binding"**
   - **Variable name**: 输入 `DB`（同样）
   - **KV namespace**: 选择预览环境命名空间（例如 `psychological-assessment-db-preview`）
   - 点击 **"Save"**

5. **验证绑定**
   - 确认两个绑定都已保存
   - 变量名必须是 `DB`（与代码中的 `context.env.DB` 对应）

**截图示意：**
```
Variable name: DB
KV namespace: psychological-assessment-db (Production)
              psychological-assessment-db-preview (Preview)
```

---

## 🔐 第五步：配置环境变量

### 5.1 配置 JWT 密钥

1. **生成 JWT 密钥**
   - 打开终端，运行：
   ```bash
   # Linux/Mac
   openssl rand -base64 32
   
   # Windows PowerShell
   [Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
   ```
   - 或者使用在线工具生成随机字符串（至少 32 个字符）

2. **在 Cloudflare 添加环境变量**
   - 在 Pages 项目的 **Settings** > **Environment Variables**
   - 点击 **"Add variable"**
   - **Variable name**: `JWT_SECRET`
   - **Value**: 粘贴你生成的密钥
   - **Environment**: 选择 **"Production"** 和 **"Preview"**（两个都勾选）
   - 点击 **"Save"**

3. **其他可选环境变量**
   - 如果需要，还可以添加其他环境变量

---

## 🚀 第六步：部署项目

### 方式 A：通过 Git 集成（自动部署）

1. **提交并推送代码**
   ```bash
   git add .
   git commit -m "Add Cloudflare Functions backend API"
   git push
   ```

2. **查看部署状态**
   - 在 Cloudflare Dashboard 的 Pages 项目中
   - 点击 **"Deployments"** 标签
   - 可以看到部署进度和日志

3. **等待部署完成**
   - 通常需要 2-5 分钟
   - 部署成功后，会显示绿色的成功状态

### 方式 B：手动部署

```bash
# 确保已构建
npm run build

# 使用 Wrangler 部署
npx wrangler pages deploy dist

# 或者指定项目名称
npx wrangler pages deploy dist --project-name=psychological-assessment-platform
```

### 部署后验证

部署完成后，你会得到一个 URL，例如：
```
https://psychological-assessment-platform.pages.dev
```

访问这个 URL 应该能看到你的前端页面。

---

## 👤 第七步：初始化管理员账号

部署完成后，需要创建一个管理员账号才能使用系统。

### 方法 1：通过 KV Dashboard 手动创建（推荐）

#### 步骤 1：获取用户 ID 和密码哈希

1. **生成用户 ID**
   ```bash
   # 在终端运行
   node -e "console.log(Date.now() + '-' + Math.random().toString(36).substring(2, 9))"
   ```
   记录下生成的 ID，例如：`1704067200000-abc1234`

2. **生成密码哈希**
   打开浏览器控制台，运行：
   ```javascript
   // 在浏览器控制台运行
   btoa('admin123').replace(/=/g, '')
   ```
   记录下哈希值（这是简化版的哈希，仅用于演示）

#### 步骤 2：在 KV 中创建管理员账号

1. **进入 KV 管理页面**
   - Cloudflare Dashboard > Workers & Pages > KV
   - 点击你的生产环境命名空间

2. **添加用户数据**
   - 点击 **"Add entry"** 或 **"Edit"** > **"Create"**
   - **Key**: `user:1704067200000-abc1234`（替换为你生成的 ID）
   - **Value**（选择 JSON 格式）：
   ```json
   {
     "id": "1704067200000-abc1234",
     "username": "admin",
     "email": "admin@example.com",
     "password": "YWRtaW4xMjM=",
     "name": "管理员",
     "role": "admin",
     "status": "active",
     "remainingQuota": 1000,
     "createdAt": "2024-01-01T00:00:00.000Z"
   }
   ```
   - 点击 **"Save"**

3. **添加到用户索引**
   - **Key**: `users:index`
   - **Value**（JSON 格式）：
   ```json
   ["1704067200000-abc1234"]
   ```
   - 点击 **"Save"**

### 方法 2：通过 API 注册后修改（更简单）

1. **注册账号**
   - 访问你的部署地址：`https://your-project.pages.dev/register`
   - 注册一个新账号（用户名、邮箱、密码）

2. **在 KV 中查找并修改**
   - 进入 KV 命名空间
   - 查找键名为 `user:` 开头的条目
   - 找到你刚注册的用户
   - 编辑该用户，将：
     - `"role": "user"` 改为 `"role": "admin"`
     - `"status": "pending"` 改为 `"status": "active"`
   - 保存

### 方法 3：使用初始化脚本（待实现）

可以创建一个 Cloudflare Worker 脚本来初始化数据。

---

## ✅ 第八步：验证部署

### 8.1 测试前端访问

1. 访问你的部署地址：`https://your-project.pages.dev`
2. 应该能看到登录页面

### 8.2 测试 API

#### 方法 1：使用浏览器

访问以下 URL，应该返回 JSON 响应：

```
https://your-project.pages.dev/api/questionnaires/available
```

如果返回 JSON 数据（即使为空数组 `{"success":true,"data":[]}`），说明 API 工作正常。

#### 方法 2：使用 curl 命令

```bash
curl https://your-project.pages.dev/api/questionnaires/available
```

#### 方法 3：使用前端登录

1. 访问登录页面
2. 使用创建的管理员账号登录
3. 如果登录成功，说明整个系统工作正常

### 8.3 检查 KV 数据

1. 登录后，在 KV 中查看
2. 应该能看到新创建的数据键值对

---

## 🔍 第九步：故障排除

### 问题 1：API 返回 404

**原因**：路由配置问题

**解决方法**：
- 检查 `functions/api/[[path]].js` 文件是否存在
- 确认构建后 `dist/functions/` 目录下有这些文件
- 检查 middleware 是否正确放行 `/api/*` 路由

### 问题 2：API 返回 500 错误

**原因**：KV 未绑定或代码错误

**解决方法**：
1. 检查 KV 绑定是否正确（Settings > Functions > KV namespace bindings）
2. 检查变量名是否为 `DB`（区分大小写）
3. 查看部署日志中的错误信息

### 问题 3：登录失败

**原因**：用户不存在或密码错误

**解决方法**：
- 确认管理员账号已在 KV 中创建
- 检查用户数据的 JSON 格式是否正确
- 确认用户状态为 `"active"`

### 问题 4：CORS 错误

**原因**：CORS 配置问题

**解决方法**：
- 检查 API 响应是否包含 CORS 头
- 在生产环境中可能需要限制 CORS 来源

### 问题 5：KV 读写失败

**原因**：KV 绑定不正确或超出限制

**解决方法**：
- 确认 KV 命名空间已正确绑定
- 检查是否超出免费版 KV 的读写限制
- 查看 Cloudflare Dashboard 中的 KV 使用情况

---

## 📊 第十步：监控和维护

### 10.1 查看日志

1. 在 Pages 项目中，点击 **"Functions"** > **"Logs"**
2. 可以查看实时日志和错误信息

### 10.2 监控 KV 使用量

1. 在 KV 页面查看使用情况
2. 注意免费版的限制（每天读取 100,000 次，写入 1,000 次）

### 10.3 备份数据

定期备份 KV 数据：
1. 在 KV 命名空间中，可以导出所有键值对
2. 或者定期备份重要的用户数据

---

## 🎯 完整检查清单

部署前检查：

- [ ] 项目已构建（`npm run build`）
- [ ] KV 命名空间已创建（生产和预览）
- [ ] KV 已绑定到 Pages 项目（变量名：`DB`）
- [ ] JWT_SECRET 环境变量已配置
- [ ] 代码已推送到 Git（如果使用 Git 集成）
- [ ] 部署已完成且成功

部署后检查：

- [ ] 前端页面可以访问
- [ ] API 路由可以访问（`/api/questionnaires/available`）
- [ ] 管理员账号已创建
- [ ] 可以成功登录
- [ ] KV 中有数据存储

---

## 🆘 获取帮助

如果遇到问题：

1. **查看日志**：Cloudflare Dashboard > Pages > Functions > Logs
2. **检查文档**：
   - `CLOUDFLARE_BACKEND_SETUP.md` - 部署指南
   - `README_BACKEND.md` - API 文档
3. **常见问题**：参考上面的故障排除部分

---

## 🎉 完成！

如果以上步骤都完成，你的后端 API 应该已经成功部署并运行了！

现在你可以：
- ✅ 使用前端登录系统
- ✅ 创建和管理用户
- ✅ 导入题库
- ✅ 生成测试链接
- ✅ 查看统计数据

祝你使用愉快！🚀

