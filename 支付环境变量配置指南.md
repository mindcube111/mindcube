# 支付环境变量配置指南

## 问题描述
错误：`支付配置未完成：ZPAY_PID 或 ZPAY_KEY 环境变量未配置`

## 解决步骤

### 方法 1：在 Cloudflare Dashboard 配置（推荐）

1. **登录 Cloudflare Dashboard**
   - 访问：https://dash.cloudflare.com/
   - 登录您的账号

2. **进入 Pages 项目设置**
   - 点击左侧菜单 "Workers & Pages"
   - 找到您的项目（psychological-assessment-platform 或类似名称）
   - 点击项目名称进入项目详情

3. **配置环境变量**
   - 点击顶部菜单 "Settings"（设置）
   - 左侧菜单选择 "Variables"（变量）
   - 在 "Environment variables" 部分添加以下变量：

   **生产环境（Production）：**
   ```
   变量名: ZPAY_PID
   值: 2025120114591699  （您的易支付商户ID）
   
   变量名: ZPAY_KEY
   值: MDZp0p...WnFm  （您的易支付商户密钥，完整的32位密钥）
   
   变量名: PUBLIC_BASE_URL
   值: https://mindcube.top  （您的网站域名）
   ```

   **预览环境（Preview）（可选）：**
   如果需要测试，也可以为预览环境配置相同的变量。

4. **保存并重新部署**
   - 点击 "Save" 保存变量
   - **重要**：环境变量修改后，必须重新部署才能生效
   - 方法1：在 "Deployments" 标签页，点击最新部署右侧的 "..." → "Retry deployment"
   - 方法2：推送新的代码提交（git push），触发自动部署

### 方法 2：通过 Wrangler CLI 配置

如果您使用 Wrangler CLI，可以在项目根目录执行：

```bash
# 配置生产环境变量
wrangler pages secret put ZPAY_PID --project-name=your-project-name
# 输入值时粘贴：2025120114591699

wrangler pages secret put ZPAY_KEY --project-name=your-project-name  
# 输入值时粘贴：您的完整32位密钥

wrangler pages secret put PUBLIC_BASE_URL --project-name=your-project-name
# 输入值时粘贴：https://mindcube.top
```

## 验证配置

配置完成后，通过以下方式验证：

1. **检查环境变量是否生效**
   - 访问：https://mindcube.top/api/payment/create
   - 如果返回配置错误，说明环境变量仍未生效，需要重新部署

2. **查看部署日志**
   - 在 Cloudflare Dashboard → 项目 → Deployments
   - 查看最新部署的日志，确认没有环境变量相关的错误

3. **测试支付功能**
   - 访问购买套餐页面
   - 点击 "立即购买"
   - 应该能正常跳转到支付页面

## 常见问题

### Q1: 已配置环境变量但仍有错误？
**A:** 环境变量修改后必须重新部署才能生效。请执行以下任一操作：
- 推送新的代码提交（git commit + git push）
- 在 Dashboard 中手动触发重新部署

### Q2: 如何确认环境变量已正确配置？
**A:** 
- 检查变量名称大小写是否完全一致：`ZPAY_PID`、`ZPAY_KEY`（全部大写）
- 确认值没有多余的空格
- 确认 ZPAY_KEY 是完整的32位密钥，不是占位符

### Q3: 变量名应该是 `VITE_ZPAY_PID` 还是 `ZPAY_PID`？
**A:** 在 Cloudflare Pages Functions 中应该使用 `ZPAY_PID` 和 `ZPAY_KEY`（不带 VITE_ 前缀）。代码会自动尝试两种命名方式。

### Q4: 预览环境和生产环境有什么区别？
**A:** 
- 生产环境（Production）：正式用户访问的版本，使用生产环境的变量
- 预览环境（Preview）：每次推送代码后的预览版本，使用预览环境的变量
- 建议两个环境都配置相同的变量，以便测试

## 环境变量参考值

根据之前的配置记录：
- **ZPAY_PID**: `2025120114591699`
- **ZPAY_KEY**: 您的32位MD5密钥（从易支付平台获取）
- **PUBLIC_BASE_URL**: `https://mindcube.top`

## 立即执行

1. ✅ 访问 Cloudflare Dashboard
2. ✅ 找到 Pages 项目
3. ✅ Settings → Variables
4. ✅ 添加三个环境变量
5. ✅ 保存并重新部署
6. ✅ 测试支付功能

