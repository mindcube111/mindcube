# 支付接口实现验证报告

## 📋 商户信息核对

根据您提供的易支付API文档：

- **商户ID（PID）**: `2025120114591699` ✅
- **商户密钥（PKEY）**: `MDZp0po0WbUsFhzLtgMLbAcHIYa8WnFm` ✅
- **接口地址**: `https://zpayz.cn/submit.php` ✅

## ✅ 实现验证结果

### 1. 签名算法实现 ✅ **正确**

**文档要求**：
1. 参数按ASCII码从小到大排序（a-z）
2. sign、sign_type、空值不参与签名
3. 参数值不要进行url编码
4. sign = md5(a=b&c=d&e=f + KEY)，md5结果为小写

**当前实现**（`functions/utils/zpay.js`）：
- ✅ 正确排除 `sign` 和 `sign_type`
- ✅ 正确排除空值（`undefined`, `null`, `''`）
- ✅ 使用 `localeCompare` 按ASCII排序
- ✅ 参数值直接转为字符串，不进行URL编码：`String(v)`
- ✅ 拼接格式正确：`${payload}${key}`
- ✅ MD5结果返回小写（`toHex` 函数返回小写十六进制）

**结论**: ✅ 签名算法实现完全符合文档要求

### 2. 参数构建 ✅ **正确**

**文档要求的必要参数**：
- ✅ `name` - 商品名称
- ✅ `money` - 订单金额
- ✅ `type` - 支付方式（alipay/wxpay）
- ✅ `out_trade_no` - 订单编号
- ✅ `notify_url` - 异步通知页面
- ✅ `pid` - 商户唯一标识
- ✅ `return_url` - 跳转页面
- ✅ `sign` - 签名
- ✅ `sign_type` - 签名方法（MD5）

**可选参数**：
- ✅ `param` - 附加内容（已实现）
- ⚠️ `cid` - 支付渠道ID（未实现，可后续添加）

**当前实现**（`functions/api/[[path]].js`）：
- ✅ 所有必要参数都已正确添加
- ✅ 只添加非空值
- ✅ 参数类型正确（都转为String）

**结论**: ✅ 参数构建符合文档要求

### 3. URL构建 ✅ **基本正确，需确认编码**

**文档说明**：
- 支持 POST 或 GET（推荐POST）
- 当前实现：构建URL后由前端跳转（GET方式）

**当前实现**（`functions/api/[[path]].js:424-431`）：
```javascript
const url = new URL('https://zpayz.cn/submit.php')
Object.entries(baseParams).forEach(([k, v]) => {
  if (v !== undefined && v !== null && v !== '') {
    url.searchParams.set(k, String(v))  // ⚠️ 这里会自动进行URL编码
  }
})
url.searchParams.set('sign', sign)
url.searchParams.set('sign_type', 'MD5')
```

**潜在问题**：
⚠️ `URL.searchParams.set()` 会自动对参数值进行URL编码，但文档要求"参数值不要进行url编码"指的是**签名字符串中的参数值不编码**，不是URL中的参数值。

**实际情况**：
- 签名时：参数值不编码 ✅（正确）
- URL构建时：参数值需要编码 ✅（这是正常的，URL参数必须编码）

**结论**: ✅ URL构建是正确的，URL参数编码是必需的

### 4. 签名验证 ⚠️ **需要确认MD5大小写**

**当前实现**：
```javascript
export function verifyMd5Sign(params, key) {
  const { sign, sign_type, ...rest } = params
  if (!sign) return false
  const expected = md5Sign(rest, key)
  return String(sign).toLowerCase() === expected.toLowerCase()  // ✅ 都转为小写比较
}
```

**结论**: ✅ 签名验证实现正确

## 🔍 详细检查项

### 1. 参数顺序检查

**文档要求**: 按参数名ASCII码从小到大排序

**测试用例**（假设参数）：
```
name=iPhone
money=1.00
type=alipay
out_trade_no=123
notify_url=https://...
pid=2025120114591699
return_url=https://...
```

**排序后应该是**（ASCII顺序）：
```
money
name
notify_url
out_trade_no
pid
return_url
type
```

**当前实现**: 使用 `localeCompare` 排序，等同于ASCII排序 ✅

### 2. 签名生成检查

**文档示例**：
```
sign = md5(money=1&name=iphone&notify_url=xxx&out_trade_no=xxx&pid=xxx&return_url=xxx&type=alipay + KEY)
```

**当前实现**：
```javascript
const payload = entries.map(([k, v]) => `${k}=${String(v)}`).join('&')
const raw = `${payload}${key}`
const sign = md5(raw)
```

✅ 实现正确

## ⚠️ 发现的问题

### 问题1: 商户密钥可能有拼写错误

您提供的密钥：`MDZp0po0WbUsFhzLtgMLbAcHIYa8WnFm`

但在日志中看到的密钥预览：`MDZp0p00WbUsFhzLtgMLbACHIYa8WnFm`

**差异**：
- 您提供的：`MDZp0po0...`（第二个0后面是o，然后是0）
- 日志中的：`MDZp0p00...`（第二个0后面是p，然后是00）

**请确认**：
1. 在易支付后台复制的密钥是否与您提供的完全一致？
2. Cloudflare Dashboard 中的 `ZPAY_KEY` 值是否正确？

### 问题2: 参数值中的特殊字符

如果商品名称或其他参数包含特殊字符（如中文、空格、特殊符号），需要确保：
- ✅ 签名时不编码（当前正确）
- ✅ URL构建时自动编码（当前正确）

## ✅ 总结

### 实现正确的部分：
1. ✅ 签名算法完全符合文档要求
2. ✅ 参数构建正确
3. ✅ URL构建正确（URL编码是必需的）
4. ✅ 签名验证正确

### 需要确认的部分：
1. ⚠️ **商户密钥**：请确认 Cloudflare Dashboard 中的 `ZPAY_KEY` 与易支付后台的密钥完全一致
2. ⚠️ **环境变量**：确保已重新部署 Worker，使环境变量生效

### 建议：
1. 在易支付后台重新复制密钥，确保完全一致
2. 在 Cloudflare Dashboard 中更新 `ZPAY_KEY`
3. 重新部署 Worker
4. 测试支付并查看日志中的 `=== 签名生成详情 ===` 部分
5. 对比日志中的 `key_preview` 是否与真实密钥匹配

